## The Hazard Library
## Copyright (C) 2012 GEM Foundation
##
## This program is free software: you can redistribute it and/or modify
## it under the terms of the GNU Affero General Public License as
## published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU Affero General Public License for more details.
##
## You should have received a copy of the GNU Affero General Public License
## along with this program.  If not, see <http://www.gnu.org/licenses/>.
"""
Module exports :class:`RietbrockEtAl2013MDHTT`.
"""
from __future__ import division

import numpy as np

from scipy.constants import g

from openquake.hazardlib.gsim.rietbrock_et_al_2013 import RietbrockEtAl2013MD
from openquake.hazardlib.gsim.base import CoeffsTable
from openquake.hazardlib.imt import PGA, SA


class RietbrockEtAl2013MDHTT(RietbrockEtAl2013MD):
    """
    Implements vs30 and kappa host to target adjusments for RietbrockEtAl2013MD GMPE.
    """
    
    def get_mean_and_stddevs(self, sites, rup, dists, imt, stddev_types):
        """
        Apply HTT
        """
        mean, stddevs = super(RietbrockEtAl2013MDHTT, self).get_mean_and_stddevs(sites, rup, dists, imt, stddev_types)

        if isinstance(imt, SA):
            freq = 1. / imt.period
        else:
            freq = 100.
        mean += np.log(self.get_kappa_cf(sites.kappa, freq))
        mean += np.log(self.get_vs30_cf(sites.vs30, imt))
        
        return mean, stddevs

    def get_kappa_cf(self, target_kappas, freq):
        """
        """
        host_kappa = 0.006
        host_amps = np.exp(-np.pi * host_kappa * freq)
        target_amps = np.exp(-np.pi * target_kappas * freq)
        amps = target_amps / host_amps
        return amps

    def get_vs30_cf(self, target_vs30s, imt):
        """
        """
        cfs = []
        for target_vs30 in target_vs30s:
           cfs.append(self.HTT_COEFFS[imt]['%.f' % target_vs30])
        return np.array(cfs)

    HTT_COEFFS = CoeffsTable(sa_damping=5, table="""\
imt 600 700 800 900 1000 1100 1200 1300 1400 1500 1600 1700 1800 1900 2000 2100 2200 2300 2400 2500 2600 2700
pga  3.4298 3.0049 2.6812 2.4146 2.1395 1.9381 1.7812 1.6438 1.5331 1.4410 1.3588 1.2888 1.2280 1.1728 1.1241 1.0806 1.0400 1.0035 0.9702 0.9398 0.9118 0.8859
0.03 3.1637 2.6733 2.3379 2.0945 1.8974 1.7452 1.6230 1.5191 1.4326 1.3590 1.2942 1.2378 1.1882 1.1433 1.1031 1.0669 1.0334 1.0029 0.9749 0.9491 0.9251 0.9028
0.04 2.9996 2.5530 2.2455 2.0205 1.8398 1.6990 1.5853 1.4887 1.4079 1.3389 1.2782 1.2251 1.1782 1.1359 1.0979 1.0634 1.0317 1.0028 0.9761 0.9515 0.9286 0.9074
0.05 2.8774 2.4631 2.1763 1.9653 1.7965 1.6641 1.5567 1.4657 1.3892 1.3236 1.2659 1.2154 1.1706 1.1302 1.0938 1.0608 1.0305 1.0027 0.9771 0.9534 0.9313 0.9108
0.06 2.7814 2.3925 2.1218 1.9219 1.7623 1.6366 1.5343 1.4475 1.3744 1.3116 1.2563 1.2078 1.1647 1.1258 1.0907 1.0589 1.0295 1.0026 0.9777 0.9547 0.9334 0.9135
0.08 2.6392 2.2877 2.0413 1.8580 1.7120 1.5962 1.5015 1.4212 1.3531 1.2945 1.2427 1.1970 1.1562 1.1193 1.0860 1.0558 1.0280 1.0024 0.9789 0.9572 0.9370 0.9182
0.10 2.5357 2.2115 1.9827 1.8117 1.6755 1.5670 1.4779 1.4020 1.3371 1.2810 1.2314 1.1877 1.1487 1.1136 1.0819 1.0530 1.0266 1.0023 0.9800 0.9593 0.9401 0.9222
0.12 2.4552 2.1519 1.9369 1.7756 1.6471 1.5436 1.4579 1.3849 1.3226 1.2687 1.2212 1.1793 1.1421 1.1085 1.0782 1.0506 1.0254 1.0022 0.9809 0.9611 0.9428 0.9258
0.16 2.3346 2.0625 1.8676 1.7186 1.5988 1.5022 1.4225 1.3548 1.2972 1.2474 1.2037 1.1651 1.1307 1.0998 1.0719 1.0466 1.0233 1.0020 0.9824 0.9643 0.9474 0.9317
0.20 2.2459 1.9935 1.8093 1.6689 1.5569 1.4667 1.3924 1.3295 1.2760 1.2297 1.1891 1.1533 1.1214 1.0927 1.0668 1.0432 1.0217 1.0019 0.9837 0.9668 0.9511 0.9365
0.25 2.1538 1.9170 1.7455 1.6154 1.5122 1.4292 1.3608 1.3030 1.2538 1.2112 1.1739 1.1410 1.1116 1.0853 1.0614 1.0398 1.0199 1.0017 0.9850 0.9694 0.9550 0.9415
0.31 2.0563 1.8379 1.6805 1.5615 1.4673 1.3916 1.3292 1.2766 1.2317 1.1929 1.1588 1.1288 1.1020 1.0779 1.0561 1.0364 1.0182 1.0016 0.9862 0.9720 0.9587 0.9463
0.40 1.9344 1.7405 1.6013 1.4962 1.4131 1.3463 1.2913 1.2448 1.2052 1.1710 1.1410 1.1145 1.0909 1.0696 1.0503 1.0326 1.0164 1.0014 0.9876 0.9747 0.9626 0.9513
0.50 1.8253 1.6541 1.5313 1.4386 1.3655 1.3071 1.2591 1.2186 1.1839 1.1538 1.1273 1.1036 1.0825 1.0633 1.0458 1.0298 1.0150 1.0013 0.9886 0.9768 0.9657 0.9552
0.63 1.7120 1.5648 1.4607 1.3829 1.3215 1.2719 1.2306 1.1954 1.1650 1.1385 1.1149 1.0938 1.0748 1.0575 1.0417 1.0271 1.0137 1.0012 0.9896 0.9787 0.9685 0.9589
0.79 1.6078 1.4888 1.4032 1.3379 1.2856 1.2427 1.2067 1.1758 1.1489 1.1253 1.1041 1.0852 1.0680 1.0524 1.0380 1.0248 1.0125 1.0011 0.9904 0.9805 0.9711 0.9622
1.00 1.5216 1.4250 1.3538 1.2985 1.2537 1.2165 1.1850 1.1578 1.1340 1.1130 1.0941 1.0771 1.0617 1.0476 1.0346 1.0226 1.0114 1.0010 0.9913 0.9822 0.9736 0.9655
1.25 1.4554 1.3746 1.3140 1.2663 1.2272 1.1946 1.1668 1.1426 1.1213 1.1025 1.0855 1.0702 1.0562 1.0434 1.0315 1.0206 1.0104 1.0009 0.9920 0.9837 0.9758 0.9683
1.59 1.3956 1.3281 1.2766 1.2356 1.2018 1.1734 1.1489 1.1276 1.1088 1.0920 1.0769 1.0632 1.0506 1.0391 1.0285 1.0186 1.0094 1.0008 0.9928 0.9852 0.9780 0.9713
2.00 1.3466 1.2892 1.2450 1.2094 1.1799 1.1549 1.1333 1.1144 1.0977 1.0827 1.0692 1.0569 1.0456 1.0353 1.0257 1.0168 1.0085 1.0008 0.9935 0.9866 0.9801 0.9740
2.50 1.3044 1.2552 1.2170 1.1860 1.1601 1.1381 1.1191 1.1023 1.0875 1.0741 1.0621 1.0511 1.0410 1.0317 1.0231 1.0151 1.0077 1.0007 0.9941 0.9879 0.9820 0.9765
3.13 1.2660 1.2239 1.1909 1.1640 1.1415 1.1222 1.1055 1.0908 1.0777 1.0659 1.0552 1.0455 1.0365 1.0283 1.0206 1.0135 1.0068 1.0006 0.9947 0.9892 0.9839 0.9790
4.00 1.2275 1.1922 1.1643 1.1415 1.1222 1.1057 1.0914 1.0787 1.0674 1.0572 1.0480 1.0395 1.0318 1.0246 1.0180 1.0118 1.0060 1.0005 0.9954 0.9906 0.9860 0.9817
5.00 1.1950 1.1651 1.1414 1.1219 1.1054 1.0913 1.0790 1.0681 1.0583 1.0495 1.0416 1.0343 1.0275 1.0213 1.0156 1.0102 1.0052 1.0005 0.9960 0.9918 0.9878 0.9841
    """)

